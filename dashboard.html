const SUPABASE_URL = 'https://yvgzyymjymrgjhhthgtj.supabase.co';
const SUPABASE_KEY = 'YOUR_KEY_HERE'; // Keep your real key
const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let currentAgent = "MentorAI";
let userProfile = null;

async function init() {
    try {
        const { data: { session } } = await _supabase.auth.getSession();
        if (!session) {
            window.location.href = 'auth.html';
            return;
        }

        const user = session.user;
        
        // Safe Update: Check if element exists before setting innerText
        const nameEl = document.getElementById('userNameDisplay');
        if (nameEl) nameEl.innerText = user.email.split('@')[0];

        // The 401 Fix: Use maybeSingle() and handle the null profile case
        const { data: profile, error } = await _supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .maybeSingle();

        // Fallback profile if DB fetch fails or is empty
        userProfile = profile || { 
            id: user.id, 
            business_idea: localStorage.getItem('userBusinessIdea') || "Stealth Project" 
        };

        const ideaEl = document.getElementById('ideaDisplay');
        if (ideaEl) ideaEl.innerText = userProfile.business_idea;

    } catch (err) {
        console.error("Critical Init Error:", err);
    }
}

// Add the missing openChat function
function openChat(agent) {
    currentAgent = agent;
    const sections = ['overview', 'roadmap', 'chatArea'];
    sections.forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById('chatArea').classList.remove('hidden');
    document.getElementById('sectionTitle').innerText = agent;
    
    const chatBox = document.getElementById('chatBox');
    chatBox.innerHTML = `<div class="text-blue-400 text-xs italic">Encrypted line open with ${agent}...</div>`;
}

init();
