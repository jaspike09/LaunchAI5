<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"><title>GEMS Command | LaunchAI_4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: #020617; color: white; font-family: sans-serif; }
        .glass { background: rgba(255,255,255,0.03); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-64 border-r border-white/5 p-6 flex flex-col glass">
        <div class="font-black text-2xl mb-10 tracking-tighter italic">LAUNCH<span class="text-blue-500">AI_4</span></div>
        <nav class="space-y-2 flex-1">
            <button onclick="setAgent('SecretaryAI')" class="w-full text-left p-3 rounded-lg hover:bg-blue-600/20 text-xs font-bold transition-all uppercase tracking-widest"><i class="fa-solid fa-shield-halved mr-2 text-blue-500"></i> SecretaryAI</button>
            <button onclick="setAgent('MentorAI')" class="w-full text-left p-3 rounded-lg hover:bg-blue-600/20 text-xs font-bold transition-all uppercase tracking-widest"><i class="fa-solid fa-user-tie mr-2 text-blue-500"></i> MentorAI</button>
            <div class="pt-6 mt-6 border-t border-white/10 opacity-40">
                <div class="text-[10px] mb-4 gray-400">ARCHITECT GEMS (LOCKED)</div>
                <button class="w-full text-left p-3 text-xs cursor-not-allowed"><i class="fa-solid fa-lock mr-2"></i> AccountantAI</button>
                <button class="w-full text-left p-3 text-xs cursor-not-allowed"><i class="fa-solid fa-lock mr-2"></i> LawyerAI</button>
            </div>
        </nav>
        <div class="p-4 bg-blue-600/20 rounded-xl text-[10px] font-black text-blue-400 text-center border border-blue-500/30">FOUNDER TIER</div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="p-6 border-b border-white/5 flex justify-between items-center glass">
            <div>
                <span id="activeAgent" class="text-xs font-black uppercase tracking-widest text-blue-400 italic">SecretaryAI</span>
                <div class="text-[9px] text-slate-500 uppercase mt-1">Status: Monitoring Neural Streams</div>
            </div>
            <div class="flex items-center gap-4">
                <span class="text-[10px] text-green-500 font-bold bg-green-500/10 px-3 py-1 rounded-full"><i class="fa-solid fa-circle text-[6px] mr-1"></i> SYSTEM ONLINE</span>
            </div>
        </header>

        <div id="chat" class="flex-1 p-8 overflow-y-auto space-y-6 scrollbar-hide">
            </div>

        <div class="p-6 bg-slate-950/50 backdrop-blur-xl border-t border-white/5">
            <div class="max-w-4xl mx-auto relative">
                <input id="msg" onkeypress="if(event.key==='Enter') send()" type="text" placeholder="Command the board..." 
                       class="w-full bg-white/5 border border-white/10 p-5 rounded-2xl outline-none focus:border-blue-500/50 transition-all text-sm pr-16">
                <button onclick="send()" class="absolute right-4 top-3 text-blue-500 p-2 hover:scale-110 transition-transform">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </main>

    <script>
        let agent = "SecretaryAI";
        const chat = document.getElementById('chat');
        
        // REPLACED: Old 404-causing fetch removed.
        window.onload = () => {
            const userIdea = localStorage.getItem('userIdea') || "New Venture";
            appendMsg("SecretaryAI", `Founder, welcome back. I've briefed the board on your idea: "${userIdea}". MentorAI is skeptical but ready. What is our first move?`);
        };

        function setAgent(a) { 
            agent = a; 
            document.getElementById('activeAgent').innerText = a;
            appendMsg("System", `Switched to ${a} uplink.`);
        }

        async function send() {
            const m = document.getElementById('msg').value; 
            if(!m) return;
            appendMsg("You", m); 
            document.getElementById('msg').value = "";
            
            try {
                const res = await fetch('/api/architect', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        messages: [{role: 'user', content: m}], 
                        agent: agent, 
                        idea: localStorage.getItem('userIdea'),
                        tier: "Founder" 
                    })
                });

                if (!res.ok) throw new Error("Connection failed.");

                const reader = res.body.getReader();
                const decoder = new TextDecoder();
                let aiMsgId = appendMsg(agent, "...");
                let fullText = "";

                while (true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value);
                    // Process text-stream logic
                    const lines = chunk.split('\n');
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.substring(6));
                                if (data.choices[0].delta.content) {
                                    fullText += data.choices[0].delta.content;
                                    document.getElementById(aiMsgId).innerText = fullText;
                                }
                            } catch (e) {}
                        }
                    });
                }
            } catch (err) {
                appendMsg("System", "Error: Check OpenAI Key in Vercel Environment Variables.");
            }
        }

        function appendMsg(s, t) {
            const id = "msg-" + Date.now();
            const isUser = s === 'You';
            chat.innerHTML += `
                <div class="flex ${isUser ? 'justify-end' : 'justify-start'}">
                    <div class="max-w-2xl p-4 rounded-2xl ${isUser ? 'bg-blue-600' : 'glass'}">
                        <div class="text-[9px] font-black uppercase mb-1 opacity-50">${s}</div>
                        <div id="${id}" class="text-sm leading-relaxed">${t}</div>
                    </div>
                </div>`;
            chat.scrollTop = chat.scrollHeight;
            return id;
        }
    </script>
</body>
</html>
